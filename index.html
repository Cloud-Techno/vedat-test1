<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width-device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>
      Retro Grid Snake: Rekor Sesi Dahil, Tam √ñzellikli Final S√ºr√ºm√º
    </title>

    <style>
      /* --- CSS Ba≈ülangƒ±cƒ± (T√ºm √ñzellikler ƒ∞√ßin) --- */
      body {
        margin: 0;
        overflow: hidden;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: #1c1c1c;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }

      #game-area {
        position: relative;
        width: 100%;
        max-width: 600px;
        aspect-ratio: 1 / 1;
        box-shadow: 0 0 30px rgba(74, 255, 145, 0.5);
        border-radius: 15px;
        overflow: hidden;
      }

      #game-canvas {
        display: block;
        width: 100%;
        height: 100%;
        background-color: #2c3e50;
        transition: background-color 0.1s;
      }

      .ui-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 10;
      }

      .glass-panel {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        border-radius: 15px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        padding: 30px;
        color: white;
        text-align: center;
        pointer-events: auto;
        width: 80%;
        max-width: 350px;
      }

      h1,
      h2 {
        font-size: 2.2em;
        text-shadow: 0 0 10px #4aff91;
        color: #ccffdd;
      }

      /* High Score Yazƒ± Stili */
      #menu-high-score {
        font-size: 1.1em;
        color: #ccffdd;
        margin-top: 15px;
        font-weight: bold;
        text-shadow: 0 0 5px #4aff91;
      }

      .game-button {
        background: rgba(74, 255, 145, 0.9);
        border: none;
        color: #00331a;
        font-size: 1.2em;
        padding: 10px 25px;
        margin: 10px 5px;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: bold;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        pointer-events: auto;
      }

      .game-button:hover {
        background: #ccffdd;
        color: #00331a;
        transform: scale(1.05);
      }

      #game-stats {
        position: absolute;
        top: 10px;
        left: 10px;
        font-size: 1.3em;
        padding: 5px 15px;
        background: rgba(0, 0, 0, 0.6);
        border-radius: 5px;
        color: #ccffdd;
        display: flex;
        gap: 15px;
      }

      #countdown-screen {
        display: none;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 20;
        color: #4aff91;
        font-size: 8em;
        font-weight: bold;
        text-shadow: 0 0 20px #4aff91;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      /* √ñl√ºm Yazƒ±larƒ± ve Rekor Animasyonu */
      #death-text {
        display: none;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #ff4d4d;
        font-size: 4em;
        font-weight: bold;
        text-shadow: 0 0 20px #ff4d4d;
        z-index: 21;
        pointer-events: none;
        animation: death-pop 0.5s ease-out;
      }

      #new-record-text {
        display: none;
        color: #ffff4d; /* Sarƒ± Neon */
        font-size: 1.5em;
        font-weight: bold;
        text-shadow: 0 0 10px #ffff4d;
        margin-top: 10px;
        /* YENƒ∞ REKOR! yazƒ±sƒ± i√ßin animasyon */
        animation: record-flash 1s infinite alternate;
      }

      @keyframes death-pop {
        0% {
          transform: translate(-50%, -50%) scale(0.5);
          opacity: 0;
        }
        80% {
          transform: translate(-50%, -50%) scale(1.1);
          opacity: 1;
        }
        100% {
          transform: translate(-50%, -50%) scale(1);
          opacity: 1;
        }
      }

      @keyframes record-flash {
        0% {
          opacity: 0.8;
          transform: scale(1);
        }
        100% {
          opacity: 1;
          transform: scale(1.05);
        }
      }

      /* Mobil Joystick Stilleri */
      #dpad-container {
        position: absolute;
        bottom: 20px;
        right: 20px;
        display: grid;
        grid-template-areas: ". up ." "left . right" ". down .";
        gap: 5px;
        width: 140px;
        height: 140px;
        pointer-events: auto;
        display: none;
        background: rgba(0, 0, 0, 0.4);
        border-radius: 50%;
        box-shadow: 0 0 15px rgba(74, 255, 145, 0.8);
        padding: 10px;
      }

      .dpad-btn {
        background: rgba(74, 255, 145, 0.5);
        border: 1px solid #ccffdd;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        color: #ccffdd;
        font-size: 1.3em;
        cursor: pointer;
        user-select: none;
        transition: background 0.1s, transform 0.1s;
      }

      .dpad-btn:active {
        background: rgba(74, 255, 145, 1);
        transform: scale(0.95);
      }

      #dpad-up {
        grid-area: up;
      }
      #dpad-down {
        grid-area: down;
      }
      #dpad-left {
        grid-area: left;
      }
      #dpad-right {
        grid-area: right;
      }

      @media (max-width: 768px) {
        #dpad-container {
          display: grid;
        }
      }
      /* --- CSS Sonu --- */
    </style>
  </head>
  <body>
    <div id="game-area">
      <canvas id="game-canvas"></canvas>

      <div class="ui-container">
        <div id="game-stats" style="display: none">
          SKOR: <span id="score">0</span> | HIZ: <span id="speed-level">1</span>
        </div>

        <div id="main-menu" class="glass-panel">
          <h1>RETRO GRID SNAKE</h1>
          <p>2D ƒ±zgarada hƒ±zla b√ºy√ºy√ºn!</p>
          <div id="menu-high-score">
            En Y√ºksek Skor: <span id="high-score-display">0</span>
          </div>
          <button class="game-button" id="start-game-btn">OYUNA BA≈ûLA</button>
        </div>

        <div id="game-over-screen" class="glass-panel" style="display: none">
          <h2>OYUN Bƒ∞TTƒ∞!</h2>
          <p>Skorun: <span id="current-score-final">0</span></p>
          <p>En Y√ºksek Skor: <span id="final-high-score">0</span></p>
          <div id="new-record-text" style="display: none">
            üéâ YENƒ∞ REKOR! üéâ
          </div>
          <button class="game-button" id="restart-game-btn">TEKRAR OYNA</button>
        </div>

        <div id="countdown-screen" style="display: none">3</div>
        <div id="death-text" style="display: none">√ñLD√úN!</div>

        <div id="dpad-container">
          <div class="dpad-btn" id="dpad-up">‚¨ÜÔ∏è</div>
          <div class="dpad-btn" id="dpad-down">‚¨áÔ∏è</div>
          <div class="dpad-btn" id="dpad-left">‚¨ÖÔ∏è</div>
          <div class="dpad-btn" id="dpad-right">‚û°Ô∏è</div>
        </div>
      </div>
    </div>

    <script>
      // --- JavaScript Ba≈ülangƒ±cƒ± ---

      // --- Sabitler ve HTML Elemanlarƒ± ---
      const canvas = document.getElementById("game-canvas");
      const ctx = canvas.getContext("2d");
      const GRID_SIZE = 20;
      let TILE_SIZE;
      const HIGH_SCORE_KEY = "retroSnakeHighScore";

      // Dinamik Hƒ±z Kontrol√º
      const BASE_TICK_RATE = 150;
      const MIN_TICK_RATE = 50;
      const SPEED_INCREMENT = 10;

      let GAME_TICK_RATE = BASE_TICK_RATE;
      let gameLoop;
      let highScore = 0;

      // Web Audio Context'i ba≈ülat
      let audioCtx;
      function initAudioContext() {
        if (!audioCtx) {
          try {
            // Tek bir AudioContext kullanmak performansƒ± artƒ±rƒ±r
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          } catch (e) {
            console.warn("Web Audio API desteklenmiyor veya ba≈ülatƒ±lamadƒ±.", e);
          }
        }
      }

      // --- Ses Efektleri (Web Audio API) ---

      /**
       * √ñl√ºm Ses Efekti (D√º≈üen frekans)
       */
      function playDeathSound() {
        initAudioContext();
        if (!audioCtx) return;
        try {
          const oscillator = audioCtx.createOscillator();
          const gainNode = audioCtx.createGain();

          oscillator.type = "sawtooth";
          oscillator.frequency.setValueAtTime(100, audioCtx.currentTime);
          gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);

          oscillator.connect(gainNode);
          gainNode.connect(audioCtx.destination);

          oscillator.frequency.exponentialRampToValueAtTime(
            1,
            audioCtx.currentTime + 0.5
          );
          gainNode.gain.exponentialRampToValueAtTime(
            0.001,
            audioCtx.currentTime + 0.5
          );

          oscillator.start();
          oscillator.stop(audioCtx.currentTime + 0.5);
        } catch (e) {
          console.error("√ñl√ºm sesi √ßalƒ±namadƒ±:", e);
        }
      }

      /**
       * Yem Toplama Ses Efekti (Hƒ±zlƒ± bip)
       */
      function playPickupSound() {
        initAudioContext();
        if (!audioCtx) return;
        try {
          const oscillator = audioCtx.createOscillator();
          const gainNode = audioCtx.createGain();

          oscillator.type = "square";
          oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
          gainNode.gain.setValueAtTime(0.15, audioCtx.currentTime); // D√º≈ü√ºk vol√ºm

          oscillator.connect(gainNode);
          gainNode.connect(audioCtx.destination);

          gainNode.gain.exponentialRampToValueAtTime(
            0.001,
            audioCtx.currentTime + 0.1
          );

          oscillator.start(audioCtx.currentTime);
          oscillator.stop(audioCtx.currentTime + 0.1);
        } catch (e) {
          console.error("Toplama sesi √ßalƒ±namadƒ±:", e);
        }
      }

      /**
       * Yeni: Rekor Kƒ±rma Ses Efekti (Ba≈üarƒ±/Zafer Sesi)
       */
      function playRecordSound() {
        initAudioContext();
        if (!audioCtx) return;
        try {
          const oscillator = audioCtx.createOscillator();
          const gainNode = audioCtx.createGain();
          const duration = 0.3;

          oscillator.type = "triangle";
          gainNode.gain.setValueAtTime(0.25, audioCtx.currentTime); // Orta-Y√ºksek vol√ºm

          // Hƒ±zlƒ±, y√ºkselen melodik bip
          oscillator.frequency.setValueAtTime(1000, audioCtx.currentTime);
          oscillator.frequency.linearRampToValueAtTime(
            1500,
            audioCtx.currentTime + duration / 2
          );
          oscillator.frequency.linearRampToValueAtTime(
            2000,
            audioCtx.currentTime + duration
          );

          gainNode.gain.exponentialRampToValueAtTime(
            0.001,
            audioCtx.currentTime + duration
          );

          oscillator.connect(gainNode);
          gainNode.connect(audioCtx.destination);

          oscillator.start(audioCtx.currentTime);
          oscillator.stop(audioCtx.currentTime + duration);
        } catch (e) {
          console.error("Rekor sesi √ßalƒ±namadƒ±:", e);
        }
      }

      // --- Leaderboard Fonksiyonlarƒ± ---

      /**
       * LocalStorage'dan en y√ºksek skoru y√ºkler.
       */
      function loadHighScore() {
        const storedScore = localStorage.getItem(HIGH_SCORE_KEY);
        highScore = storedScore ? parseInt(storedScore, 10) : 0;
        updateHighScoreUI();
      }

      /**
       * En y√ºksek skoru LocalStorage'a kaydeder.
       * @returns {boolean} Yeni rekor kƒ±rƒ±ldƒ±ysa true d√∂ner.
       */
      function saveHighScore(newScore) {
        if (newScore > highScore) {
          highScore = newScore;
          localStorage.setItem(HIGH_SCORE_KEY, newScore.toString());
          return true;
        }
        return false;
      }

      /**
       * Men√º ve Game Over ekranƒ±ndaki skorlarƒ± g√ºnceller.
       */
      function updateHighScoreUI() {
        document.getElementById("high-score-display").textContent = highScore;
        document.getElementById("final-high-score").textContent = highScore;
      }

      // --- Oyun Durumu ---
      let snake = [];
      let food = {};
      let direction = { x: 1, y: 0 };
      let nextDirection = { x: 1, y: 0 };
      let score = 0;
      let gameState = "menu";
      let flashInterval;

      // --- Yardƒ±mcƒ± Fonksiyonlar ---

      function drawTile(x, y, color) {
        ctx.fillStyle = color;
        const padding = 1;
        ctx.fillRect(
          x * TILE_SIZE + padding,
          y * TILE_SIZE + padding,
          TILE_SIZE - padding * 2,
          TILE_SIZE - padding * 2
        );
      }

      function initializeSnake() {
        snake = [
          { x: 10, y: 10 },
          { x: 9, y: 10 },
          { x: 8, y: 10 },
        ];
        direction = { x: 1, y: 0 };
        nextDirection = { x: 1, y: 0 };

        GAME_TICK_RATE = BASE_TICK_RATE;
      }

      function placeFood() {
        let newPos;
        do {
          newPos = {
            x: Math.floor(Math.random() * GRID_SIZE),
            y: Math.floor(Math.random() * GRID_SIZE),
          };
        } while (
          snake.some(
            (segment) => segment.x === newPos.x && segment.y === newPos.y
          )
        );

        food = newPos;
      }

      function drawGame() {
        ctx.fillStyle = "#2c3e50";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        if (gameState === "menu" || gameState === "countdown") return;

        snake.forEach((segment, index) => {
          const color = index === 0 ? "#ff4d4d" : "#4aff91";
          drawTile(segment.x, segment.y, color);
        });

        // Yem rengi parlak sarƒ±
        drawTile(food.x, food.y, "#ffff4d");
      }

      function updateSpeed() {
        let newTickRate;
        let speedLevel = 1;

        if (score < 5) {
          newTickRate = BASE_TICK_RATE;
          speedLevel = 1;
        } else if (score < 10) {
          newTickRate = BASE_TICK_RATE - SPEED_INCREMENT * 1;
          speedLevel = 2;
        } else {
          const speedStage = Math.floor(score / 5);

          newTickRate = BASE_TICK_RATE - speedStage * SPEED_INCREMENT;

          newTickRate = Math.max(newTickRate, MIN_TICK_RATE);
          speedLevel = speedStage + 1;
        }

        if (newTickRate !== GAME_TICK_RATE) {
          GAME_TICK_RATE = newTickRate;
          clearInterval(gameLoop);
          gameLoop = setInterval(moveSnake, GAME_TICK_RATE);
        }

        document.getElementById("speed-level").textContent = speedLevel;
      }

      function moveSnake() {
        if (gameState !== "playing") return;

        if (
          nextDirection.x !== -direction.x ||
          nextDirection.y !== -direction.y
        ) {
          direction = nextDirection;
        }

        const newHead = {
          x: snake[0].x + direction.x,
          y: snake[0].y + direction.y,
        };

        // √áarpƒ±≈üma Kontrol√º
        if (
          newHead.x < 0 ||
          newHead.x >= GRID_SIZE ||
          newHead.y < 0 ||
          newHead.y >= GRID_SIZE ||
          snake
            .slice(1)
            .some(
              (segment) => segment.x === newHead.x && segment.y === newHead.y
            )
        ) {
          endGame();
          return;
        }

        snake.unshift(newHead);

        // Yem Kontrol√º
        if (newHead.x === food.x && newHead.y === food.y) {
          score += 1;
          playPickupSound();
          updateStatsUI();
          placeFood();
          updateSpeed();
        } else {
          snake.pop();
        }

        drawGame();
      }

      function deathAnimation() {
        playDeathSound();

        let flashCount = 0;
        flashInterval = setInterval(() => {
          if (flashCount < 6) {
            const color = flashCount % 2 === 0 ? "#ff0000" : "#000000";
            canvas.style.backgroundColor = color;
          } else {
            clearInterval(flashInterval);
            canvas.style.backgroundColor = "#2c3e50";
          }
          flashCount++;
        }, 80);

        document.getElementById("death-text").style.display = "block";
        setTimeout(() => {
          document.getElementById("death-text").style.display = "none";
        }, 1000);
      }

      function endGame() {
        gameState = "gameover";
        clearInterval(gameLoop);

        deathAnimation();

        // √áarpƒ±≈üma anƒ±nƒ± g√∂rselle≈ütir
        ctx.fillStyle = "#ff0000";
        snake.forEach((segment) => drawTile(segment.x, segment.y, "#ff0000"));

        // Y√ºksek Skoru Kontrol Et ve Kaydet
        const isNewRecord = saveHighScore(score);

        // Game Over Ekranƒ±nƒ± hazƒ±rla
        if (isNewRecord) {
          playRecordSound(); // YENƒ∞ REKOR SES EFEKTƒ∞ √áALIYOR
          document.getElementById("new-record-text").style.display = "block";
        } else {
          document.getElementById("new-record-text").style.display = "none";
        }

        // Skorlarƒ± ayarla
        document.getElementById("current-score-final").textContent = score;
        updateHighScoreUI();

        // Ekranƒ± g√∂ster
        setTimeout(() => {
          document.getElementById("game-over-screen").style.display = "block";
          document.getElementById("game-stats").style.display = "none";
        }, 1000);
      }

      function updateStatsUI() {
        document.getElementById("score").textContent = score;
        document.getElementById("speed-level").textContent = 1;
      }

      function startCountdown() {
        initAudioContext();

        gameState = "countdown";
        document.getElementById("main-menu").style.display = "none";
        document.getElementById("game-over-screen").style.display = "none";
        document.getElementById("game-stats").style.display = "block";
        document.getElementById("countdown-screen").style.display = "flex";

        let count = 3;
        document.getElementById("countdown-screen").textContent = count;

        const countdownLoop = setInterval(() => {
          count--;
          if (count >= 1) {
            document.getElementById("countdown-screen").textContent = count;
          } else if (count === 0) {
            document.getElementById("countdown-screen").textContent = "BA≈ûLA!";
          } else {
            clearInterval(countdownLoop);
            document.getElementById("countdown-screen").style.display = "none";
            startGameLoop();
          }
        }, 1000);
      }

      function startGameLoop() {
        initializeSnake();
        placeFood();
        score = 0;
        gameState = "playing";
        updateStatsUI();
        updateSpeed();

        gameLoop = setInterval(moveSnake, GAME_TICK_RATE);

        drawGame();
      }

      // --- Kontroller ve Olay Dinleyicileri ---

      function handleInput(key) {
        if (gameState !== "playing") return;

        let newDir = { x: direction.x, y: direction.y };

        if (key === "ArrowUp" || key === "w" || key === "W") {
          newDir = { x: 0, y: -1 };
        } else if (key === "ArrowDown" || key === "s" || key === "S") {
          newDir = { x: 0, y: 1 };
        } else if (key === "ArrowLeft" || key === "a" || key === "A") {
          newDir = { x: -1, y: 0 };
        } else if (key === "ArrowRight" || key === "d" || key === "D") {
          newDir = { x: 1, y: 0 };
        }

        if (newDir.x !== -direction.x || newDir.y !== -direction.y) {
          nextDirection = newDir;
        }
      }

      function resizeCanvas() {
        const gameArea = document.getElementById("game-area");
        const size = Math.min(
          window.innerWidth - 40,
          window.innerHeight - 40,
          600
        );

        gameArea.style.width = `${size}px`;
        gameArea.style.height = `${size}px`;

        canvas.width = size;
        canvas.height = size;

        TILE_SIZE = canvas.width / GRID_SIZE;

        drawGame();
      }

      window.addEventListener("resize", resizeCanvas);

      document.addEventListener("keydown", (event) => {
        if (gameState === "playing") {
          handleInput(event.key);
        } else if (
          (gameState === "menu" || gameState === "gameover") &&
          event.key === " "
        ) {
          startCountdown();
        }
      });

      document
        .getElementById("start-game-btn")
        .addEventListener("click", startCountdown);
      document
        .getElementById("restart-game-btn")
        .addEventListener("click", startCountdown);

      const dpadButtons = [
        { id: "dpad-up", key: "ArrowUp" },
        { id: "dpad-down", key: "ArrowDown" },
        { id: "dpad-left", key: "ArrowLeft" },
        { id: "dpad-right", key: "ArrowRight" },
      ];

      dpadButtons.forEach((btn) => {
        const element = document.getElementById(btn.id);
        element.addEventListener("touchstart", (e) => {
          e.preventDefault();
          if (gameState === "playing") handleInput(btn.key);
        });
      });

      // --- Ba≈ülangƒ±√ß Y√ºklemesi ---
      resizeCanvas();
      loadHighScore();

      // --- JavaScript Sonu ---
    </script>
  </body>
</html>
